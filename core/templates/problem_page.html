{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solve: {{ problem.title }}</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#1E4A7A',
                        editor: '#1e1e1e',
                        terminal: '#0f0f0f'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <nav class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-4">
            <a href="{% url 'problems' %}" class="text-gray-500 hover:text-black transition">
                <i class="fas fa-chevron-left"></i> Back
            </a>
            <h1 class="font-bold text-lg text-gray-800">{{ problem.title }}</h1>
            <span class="text-xs px-2 py-1 rounded 
                {% if problem.difficulty == 'Easy' %}bg-green-100 text-green-700
                {% elif problem.difficulty == 'Medium' %}bg-yellow-100 text-yellow-700
                {% else %}bg-red-100 text-red-700{% endif %}">
                {{ problem.difficulty }}
            </span>
        </div>
        
        <div class="flex gap-3">
            <button id="runBtn" onclick="runCode()" class="flex items-center gap-2 bg-gray-200 text-gray-700 px-4 py-1.5 rounded hover:bg-gray-300 transition font-medium">
                <i class="fas fa-play text-sm"></i> Run Code
            </button>
            <button id="submitBtn" onclick="submitSolution()" class="flex items-center gap-2 bg-blue-600 text-white px-6 py-1.5 rounded hover:bg-blue-700 transition font-medium shadow-md">
                <i class="fas fa-paper-plane text-sm"></i> Submit
            </button>
        </div>
    </nav>

    <div class="flex-1 flex overflow-hidden">
        
        <div class="w-5/12 p-6 overflow-y-auto bg-white border-r border-gray-200 shadow-inner">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Problem Statement</h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed text-sm">
                <p class="mb-4 whitespace-pre-line">{{ problem.statement }}</p>
                
                <div class="grid grid-cols-1 gap-4 mt-6">
                    <div>
                        <h3 class="font-bold text-gray-900 mb-1">Input Format</h3>
                        <p class="bg-gray-50 p-2 rounded border text-sm">{{ problem.input_fmt }}</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-900 mb-1">Output Format</h3>
                        <p class="bg-gray-50 p-2 rounded border text-sm">{{ problem.output_fmt }}</p>
                    </div>
                </div>

                <h3 class="font-bold text-gray-900 mt-6 mb-1">Constraints</h3>
                <code class="bg-red-50 text-red-600 px-2 py-1 rounded block border border-red-100 w-max">{{ problem.constraints }}</code>

                <div class="mt-6">
                    <h4 class="font-bold text-gray-800 text-sm uppercase tracking-wide mb-2">Sample Case</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-xs text-gray-500 font-bold">INPUT</span>
                            <pre class="bg-gray-800 text-gray-100 p-3 rounded mt-1 text-xs overflow-x-auto border border-gray-700">{{ problem.sample_input }}</pre>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500 font-bold">OUTPUT</span>
                            <pre class="bg-gray-800 text-gray-100 p-3 rounded mt-1 text-xs overflow-x-auto border border-gray-700">{{ problem.sample_output }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-7/12 flex flex-col bg-editor">
            
            <div class="flex-1 flex flex-col p-4">
                <div class="flex justify-between text-gray-400 text-xs mb-2 font-mono uppercase tracking-wider">
                    <span>Python 3 (Piston API)</span>
                    <span>main.py</span>
                </div>
                
                <textarea id="codeEditor" 
                    class="w-full h-full bg-transparent text-gray-300 font-mono text-sm outline-none resize-none placeholder-gray-600 leading-6"
                    spellcheck="false"
                    placeholder="# Write your Python code here...&#10;import sys&#10;&#10;def solve():&#10;    # Read input&#10;    data = sys.stdin.read().split()&#10;    if not data: return&#10;    &#10;    # Your logic here&#10;    print(data[0])&#10;&#10;if __name__ == '__main__':&#10;    solve()">
# Write your solution here
import sys

def solve():
    # Read all input from stdin
    input_data = sys.stdin.read()
    if not input_data: return

    # Logic goes here
    # print(result)

if __name__ == "__main__":
    solve()
</textarea>
            </div>

            <div class="h-1/3 bg-terminal border-t border-gray-700 flex flex-col">
                <div class="px-4 py-2 bg-[#1a1a1a] border-b border-gray-700 flex justify-between items-center">
                    <span class="text-gray-400 text-xs font-bold uppercase">Execution Output</span>
                    <button onclick="clearOutput()" class="text-gray-500 hover:text-white text-xs"><i class="fas fa-trash"></i> Clear</button>
                </div>
                <div id="outputArea" class="p-4 overflow-auto font-mono text-sm text-gray-300 h-full whitespace-pre-wrap">
                    <span class="text-gray-600 italic">Click 'Run' to test against sample input or 'Submit' to grade.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const PROBLEM_ID = "{{ problem.id }}";
        const CSRF_TOKEN = "{{ csrf_token }}";
        const SAMPLE_INPUT = `{{ problem.sample_input|escapejs }}`;
        
        // -- 1. RUN CODE FUNCTION --
        async function runCode() {
            const code = document.getElementById('codeEditor').value;
            const outputDiv = document.getElementById('outputArea');
            const btn = document.getElementById('runBtn');

            // UI Loading State
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            btn.disabled = true;
            outputDiv.innerHTML = '<span class="text-yellow-500">Executing against Sample Input...</span>';

            try {
                // Call 'run_code' view (Assuming URL is mapped in urls.py)
                // We use the generic 'run_code' view we created that takes raw stdin
                const response = await fetch("{% url 'run_code' %}", { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        code: code,
                        language: 'python',
                        stdin: SAMPLE_INPUT // Send the sample input specifically
                    })
                });

                const data = await response.json();

                // Display Logic
                if (data.run) {
                    const output = data.run.stdout || "";
                    const error = data.run.stderr || "";
                    
                    if (data.run.code === 0) {
                        outputDiv.innerHTML = `<span class="text-green-400 font-bold mb-2 block">✓ Compiled Successfully</span>` + 
                                              `<span class="text-white">${output}</span>`;
                    } else {
                        outputDiv.innerHTML = `<span class="text-red-500 font-bold mb-2 block">⚠ Runtime Error</span>` + 
                                              `<span class="text-red-300">${error}</span>`;
                    }
                } else {
                    outputDiv.innerHTML = `<span class="text-red-500">API Error: ${data.error || 'Unknown'}</span>`;
                }

            } catch (error) {
                outputDiv.innerHTML = `<span class="text-red-500">Network Error: ${error.message}</span>`;
            } finally {
                btn.innerHTML = '<i class="fas fa-play text-sm"></i> Run Code';
                btn.disabled = false;
            }
        }

        // -- 2. SUBMIT SOLUTION FUNCTION --
        async function submitSolution() {
            const code = document.getElementById('codeEditor').value;
            const outputDiv = document.getElementById('outputArea');
            const btn = document.getElementById('submitBtn');

            // UI Loading State
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Grading...';
            btn.disabled = true;
            outputDiv.innerHTML = '<span class="text-blue-400">Running against Test Cases...</span>';

            try {
                // Call 'submit_solution' view with Problem ID
                const response = await fetch(`/problem/${PROBLEM_ID}/submit/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({
                        code: code,
                        language: 'python'
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Success UI
                    outputDiv.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-green-500">
                            <i class="fas fa-check-circle text-4xl mb-2"></i>
                            <h3 class="text-xl font-bold">Accepted!</h3>
                            <p class="text-gray-400 mt-1">${data.message}</p>
                        </div>
                    `;
                    // Optional: Trigger confetti or sound here
                } else if (data.status === 'failed') {
                    // Failure UI
                    const fail = data.results.find(r => r.status === 'Failed');
                    outputDiv.innerHTML = `
                        <div class="text-red-500 font-bold mb-2">✕ Wrong Answer</div>
                        <div class="bg-gray-800 p-3 rounded text-sm">
                            <div class="mb-2">
                                <span class="text-gray-500 text-xs uppercase">Input</span>
                                <pre class="text-white">${fail.input}</pre>
                            </div>
                            <div class="mb-2">
                                <span class="text-gray-500 text-xs uppercase">Expected Output</span>
                                <pre class="text-green-400">${fail.expected}</pre>
                            </div>
                            <div>
                                <span class="text-gray-500 text-xs uppercase">Your Output</span>
                                <pre class="text-red-400">${fail.actual}</pre>
                            </div>
                        </div>
                    `;
                } else {
                    // Error UI
                    outputDiv.innerHTML = `
                        <div class="text-red-500 font-bold mb-2">⚠ Execution Error</div>
                        <pre class="text-red-300 whitespace-pre-wrap">${data.details || data.message}</pre>
                    `;
                }

            } catch (error) {
                outputDiv.innerHTML = `<span class="text-red-500">System Error: ${error.message}</span>`;
            } finally {
                btn.innerHTML = '<i class="fas fa-paper-plane text-sm"></i> Submit';
                btn.disabled = false;
            }
        }

        function clearOutput() {
            document.getElementById('outputArea').innerHTML = '<span class="text-gray-600 italic">Ready.</span>';
        }
    </script>
</body>
</html>